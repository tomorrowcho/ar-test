<!DOCTYPE html>
<meta
  name="viewport"
  content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
/>
<!-- three.js library -->
<script src="vendor/three.js/build/three.min.js"></script>

<!-- three.js load GLTF -->
<script src="vendor/three.js/GLTFLoader.js"></script>

<!-- ar.js -->
<script src="../build/ar-threex.js"></script>
<script>
  THREEx.ArToolkitContext.baseURL = "../";
</script>

<body style="font-family: Monospace">
  <div
    style="
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      z-index: 1;
    "
  >
    <a href="https://github.com/AR-js-org/AR.js/" target="_blank">AR.js</a> -
    three.js camera transform
    <br />
    Contact me any time at
    <a href="https://twitter.com/nicolocarp" target="_blank">@nicolocarp</a>
  </div>
  <script>
    //////////////////////////////////////////////////////////////////////////////////
    //		Init
    //////////////////////////////////////////////////////////////////////////////////

    // init renderer
    var renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true,
    });

    var clock = new THREE.Clock();
    var mixers = [];

    renderer.setClearColor(new THREE.Color("lightgrey"), 0);
    renderer.setSize(640, 480);
    renderer.domElement.style.position = "absolute";
    renderer.domElement.style.top = "0px";
    renderer.domElement.style.left = "0px";
    document.body.appendChild(renderer.domElement);

    // array of functions for the rendering loop
    var onRenderFcts = [];
    var arToolkitContext, arMarkerControls;

    // init scene and camera
    var scene = new THREE.Scene();

    //////////////////////////////////////////////////////////////////////////////////
    //		Initialize a basic camera
    //////////////////////////////////////////////////////////////////////////////////

    // Create a camera
    var camera = new THREE.Camera();
    scene.add(camera);

    var light = new THREE.AmbientLight(0xffffff);
    scene.add(light);

    ////////////////////////////////////////////////////////////////////////////////
    //          handle arToolkitSource
    ////////////////////////////////////////////////////////////////////////////////

    var arToolkitSource = new THREEx.ArToolkitSource({
      // to read from the webcam
      sourceType: "webcam",

      sourceWidth: window.innerWidth > window.innerHeight ? 640 : 480,
      sourceHeight: window.innerWidth > window.innerHeight ? 480 : 640,

      // // to read from an image
      // sourceType : 'image',
      // sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/images/img.jpg',

      // to read from a video
      // sourceType : 'video',
      // sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/videos/headtracking.mp4',
    });

    arToolkitSource.init(function onReady() {
      arToolkitSource.domElement.addEventListener("canplay", () => {
        console.log(
          "canplay",
          "actual source dimensions",
          arToolkitSource.domElement.videoWidth,
          arToolkitSource.domElement.videoHeight
        );

        initARContext();
      });
      window.arToolkitSource = arToolkitSource;
      setTimeout(() => {
        onResize();
      }, 2000);
    });

    // handle resize
    window.addEventListener("resize", function () {
      onResize();
    });

    function onResize() {
      arToolkitSource.onResizeElement();
      arToolkitSource.copyElementSizeTo(renderer.domElement);
      if (window.arToolkitContext.arController !== null) {
        arToolkitSource.copyElementSizeTo(
          window.arToolkitContext.arController.canvas
        );
      }
    }
    ////////////////////////////////////////////////////////////////////////////////
    //          initialize arToolkitContext
    ////////////////////////////////////////////////////////////////////////////////

    function initARContext() {
      // create atToolkitContext
      arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl:
          THREEx.ArToolkitContext.baseURL + "../data/data/camera_para.dat",
        detectionMode: "mono",
      });
      // initialize it
      arToolkitContext.init(() => {
        // copy projection matrix to camera
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());

        arToolkitContext.arController.orientation = getSourceOrientation();
        arToolkitContext.arController.options.orientation =
          getSourceOrientation();

        console.log("arToolkitContext", arToolkitContext);
        window.arToolkitContext = arToolkitContext;
      });

      // MARKER
      arMarkerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
        type: "pattern",
        patternUrl:
          THREEx.ArToolkitContext.baseURL +
          "../data/data/pattern-2522866889_Cute_girl__by_Gustav_Klimt_by_Auguste_Renoir.patt",
        // patternUrl: THREEx.ArToolkitContext.baseURL + "../data/data/pattern-raccoon-color.patt",
        // patternUrl:
        // 	THREEx.ArToolkitContext.baseURL +
        // 	"examples/marker-training/examples/pattern-files/pattern-2522866889_Cute_girl__by_Gustav_Klimt_by_Auguste_Renoir.patt",
        // patternUrl: THREEx.ArToolkitContext.baseURL + "../data/data/patt.hiro",
        // patternUrl: THREEx.ArToolkitContext.baseURL + "../data/data/patt.kanji",
        // as we controls the camera, set changeMatrixMode: 'cameraTransformMatrix'
        changeMatrixMode: "cameraTransformMatrix",
      });

      scene.visible = false;

      // var root = new THREE.Object3D();
      // scene.add(root);

      console.log("ArMarkerControls", arMarkerControls);
      window.arMarkerControls = arMarkerControls;
    }

    function getSourceOrientation() {
      if (!arToolkitSource) {
        return null;
      }

      console.log(
        "actual source dimensions",
        arToolkitSource.domElement.videoWidth,
        arToolkitSource.domElement.videoHeight
      );

      if (
        arToolkitSource.domElement.videoWidth >
        arToolkitSource.domElement.videoHeight
      ) {
        console.log("source orientation", "landscape");
        return "landscape";
      } else {
        console.log("source orientation", "portrait");
        return "portrait";
      }
    }

    // update artoolkit on every frame
    onRenderFcts.push(function () {
      if (!arToolkitContext || !arToolkitSource || !arToolkitSource.ready) {
        return;
      }

      arToolkitContext.update(arToolkitSource.domElement);

      // update scene.visible if the marker is seen
      scene.visible = camera.visible;
    });

    var root = new THREE.Object3D();
    scene.add(root);

    //////////////////////////////////////////////////////////////////////////////////
    //		add an object in the scene
    //////////////////////////////////////////////////////////////////////////////////
    const loader = new THREE.GLTFLoader();
    loader.load(
      "./resources/shiba/scene.gltf",
      (gltf) => {
        scene.scale.set(10, 10, 10);
        console.log(gltf);
        scene.add(gltf.scene);
      },
      undefined,
      function (error) {
        console.error(error);
      }
    );
    // var threeGLTFLoader = new THREE.GLTFLoader();
    // var model;
    // threeGLTFLoader.load("./resources/shiba/scene.gltf", (gltfScene) => {
    // 	// model = gltfScene;
    // 	// model.name = "shiba";
    // 	root.add(model);
    // 	model.scene.add(gltfScene.scene);
    // 	// model.scene.scale.set(0.1, 0.1, 0.1);
    // });
  </script>
</body>
